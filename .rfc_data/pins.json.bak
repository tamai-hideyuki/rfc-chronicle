import json
from pathlib import Path
import click
from filelock import FileLock

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ”ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
PINS_FILE = Path(".rfc_data/pins.json")
LOCK_SUFFIX = ".lock"


def ensure_data_dir(path: Path):
path.parent.mkdir(parents=True, exist_ok=True)


def load_pins(path: Path = PINS_FILE) -> list[int]:
ensure_data_dir(path)
if not path.exists():
save_pins([], path)
lock = FileLock(str(path) + LOCK_SUFFIX)
with lock:
try:
data = json.loads(path.read_text(encoding="utf-8"))
# æ•´æ•°ã«å¤‰æ›
return [int(r) for r in data]
except json.JSONDecodeError:
backup = path.with_suffix(path.suffix + ".bak")
path.rename(backup)
save_pins([], path)
return []


def save_pins(pins: list[int], path: Path = PINS_FILE) -> None:
ensure_data_dir(path)
lock = FileLock(str(path) + LOCK_SUFFIX)
with lock:
path.write_text(json.dumps(pins, indent=2, ensure_ascii=False), encoding="utf-8")


@click.group()
def cli():
"""RFC-chronicle CLI"""
pass


@cli.command()
@click.argument('rfc', type=int)
def pin(rfc: int):
"Pin an RFC"
pins = load_pins()
if rfc in pins:
click.echo(f"RFC {rfc} ã¯ã™ã§ã«ãƒ”ãƒ³ã•ã‚Œã¦ã„ã¾ã™ã€‚")
return
pins.append(rfc)
save_pins(pins)
click.echo(f"RFC {rfc} ã‚’ãƒ”ãƒ³ã—ã¾ã—ãŸã€‚ğŸ“Œ")


@cli.command()
@click.argument('rfc', type=int)
def unpin(rfc: int):
"Unpin an RFC"
pins = load_pins()
if rfc not in pins:
click.echo(f"RFC {rfc} ã¯ãƒ”ãƒ³ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
return
pins.remove(rfc)
save_pins(pins)
click.echo(f"RFC {rfc} ã®ãƒ”ãƒ³ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚âŒ")


@cli.command(name='list')
@click.option('--pins-only', is_flag=True, help='ãƒ”ãƒ³æ¸ˆã¿ã®ã¿è¡¨ç¤º')
@click.option('--show-pins', is_flag=True, help='å…¨RFCè¡¨ç¤ºã«ãƒ”ãƒ³ãƒãƒ¼ã‚¯ã‚’ä»˜ä¸')
@click.argument('other_args', nargs=-1)
def list_rfc(pins_only: bool, show_pins: bool, other_args):
"List RFCs, with pinned markers"
# æ—¢å­˜ã®ãƒªã‚¹ãƒˆæ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—ã¤ã¤ã€ãƒ”ãƒ³å‡¦ç†ã‚’è¿½åŠ 
pins = load_pins()
# ä»®ã« fetch_metadata_list ã‚’å‘¼ã¶
from rfc_chronicle.fetch_rfc import fetch_metadata_list
all_items = fetch_metadata_list(*other_args)

def format_item(item):
mark = 'ğŸ“Œ' if item.number in pins else '   '
return f"{mark} RFC{item.number:03d}  {item.title}"

filtered = all_items
if pins_only:
filtered = [i for i in all_items if i.number in pins]

# ãƒ”ãƒ³æ¸ˆã¿ã‚’å…ˆé ­ã€ç•ªå·é †
sorted_items = sorted(filtered, key=lambda i: (i.number not in pins, i.number))

for item in sorted_items:
line = format_item(item) if show_pins or pins_only else item.summary_line()
click.echo(line)
